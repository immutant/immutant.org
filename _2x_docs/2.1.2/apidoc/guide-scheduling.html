<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>Immutant 2.1.2 API documentation</title><link href="assets/immutant.css" rel="stylesheet" type="text/css"></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Immutant 2.1.2 API documentation</a></h1></div><div class="sidebar" id="namespaces"><div id="guides"><h3><a href="index.html"><span class="inner">Guides</span></a></h3><ul><li class="guide Migration-current"><a href="guide-migration.html"><div class="inner"><span>Migration</span></div></a></li><li class="guide Installation-current"><a href="guide-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="guide Web-current"><a href="guide-web.html"><div class="inner"><span>Web</span></div></a></li><li class="guide Messaging-current"><a href="guide-messaging.html"><div class="inner"><span>Messaging</span></div></a></li><li class="guide current"><a href="guide-scheduling.html"><div class="inner"><span>Scheduling</span></div></a></li><li class="guide Caching-current"><a href="guide-caching.html"><div class="inner"><span>Caching</span></div></a></li><li class="guide Transactions-current"><a href="guide-transactions.html"><div class="inner"><span>Transactions</span></div></a></li><li class="guide WildFly-current"><a href="guide-wildfly.html"><div class="inner"><span>WildFly</span></div></a></li><li class="guide EAP 6.4.x-current"><a href="guide-EAP.html"><div class="inner"><span>EAP 6.4.x</span></div></a></li><li class="guide Logging-current"><a href="guide-logging.html"><div class="inner"><span>Logging</span></div></a></li></ul></div><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>immutant</span></div></div></li><li class="depth-2"><a href="immutant.caching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>caching</span></div></a></li><li class="depth-3 branch"><a href="immutant.caching.core-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-cache</span></div></a></li><li class="depth-3"><a href="immutant.caching.core-memoize.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-memoize</span></div></a></li><li class="depth-2"><a href="immutant.codecs.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>codecs</span></div></a></li><li class="depth-3"><a href="immutant.codecs.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2 branch"><a href="immutant.coercions.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>coercions</span></div></a></li><li class="depth-2 branch"><a href="immutant.daemons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>daemons</span></div></a></li><li class="depth-2"><a href="immutant.messaging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>messaging</span></div></a></li><li class="depth-3 branch"><a href="immutant.messaging.hornetq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hornetq</span></div></a></li><li class="depth-3"><a href="immutant.messaging.pipeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pipeline</span></div></a></li><li class="depth-2"><a href="immutant.scheduling.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>scheduling</span></div></a></li><li class="depth-3 branch"><a href="immutant.scheduling.joda.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>joda</span></div></a></li><li class="depth-3"><a href="immutant.scheduling.quartz.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>quartz</span></div></a></li><li class="depth-2"><a href="immutant.transactions.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>transactions</span></div></a></li><li class="depth-3 branch"><a href="immutant.transactions.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3"><a href="immutant.transactions.scope.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scope</span></div></a></li><li class="depth-2 branch"><a href="immutant.util.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="immutant.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-3 branch"><a href="immutant.web.ssl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ssl</span></div></a></li><li class="depth-3"><a href="immutant.web.undertow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>undertow</span></div></a></li><li class="depth-2"><a href="immutant.wildfly.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>wildfly</span></div></a></li></ul></div><div class='namespace-index guide' id='content'><div class='markdown doc'><div class="guide-content"><h1>Scheduling Guide</h1><div class="description"><span>Schedule asynchronous jobs</span></div><div id="toc"><ul><li><a href="#h5313"><span>The API</span></a><ul><li><a href="#h5314"><span>Some Examples</span></a></li><li><a href="#h5315"><span>It&rsquo;s Just Maps</span></a></li><li><a href="#h5316"><span>Supports Joda clj-time</span></a></li></ul></li><li><a href="#h5317"><span>Accessing the internal Quartz scheduler</span></a></li></ul></div><p>If you&rsquo;re coming from Immutant 1.x, you&rsquo;ll notice that the scheduling namespace and artifact have been renamed (what used to be <code>immutant.jobs</code> and <code>org.immutant/immutant-jobs</code> is now <code>immutant.scheduling</code> and <code>org.immutant/scheduling</code>), and the API has changed a bit. It&rsquo;s still based on Quartz 2.2, though.</p><h2 id="h5313">The API</h2><p>At first glance, the API for <a href="immutant.scheduling.html">immutant.scheduling</a> appears bigger than it really is, but there are only two essential functions:</p>
<ul>
  <li><a href="immutant.scheduling.html#var-schedule">schedule</a> - for scheduling your jobs</li>
  <li><a href="immutant.scheduling.html#var-stop">stop</a> - for canceling them</li>
</ul><p>The remainder of the namespace is syntactic sugar: functions that can be composed to create the specification for when your job should run.</p><p>Your &ldquo;job&rdquo; will take the form of a plain ol&rsquo; Clojure function taking no arguments. The <code>schedule</code> function takes your job and a <em>specification map</em> as arguments. The map determines when your function gets called. It may contain any of the following keys:</p>
<ul>
  <li><code>:in</code> - a period after which your function will be called</li>
  <li><code>:at</code> - an instant in time after which your function will be called</li>
  <li><code>:every</code> - the period between calls</li>
  <li><code>:until</code> - stops the calls at a specific time</li>
  <li><code>:limit</code> - limits the calls to a specific count</li>
  <li><code>:cron</code> - calls your function according to a <a href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/tutorial-lesson-06">Quartz-style</a> cron spec</li>
</ul><p>For each key there is a corresponding &ldquo;sugar function&rdquo;. We&rsquo;ll see those in the examples below.</p><p>Units for periods (<code>:in</code> and <code>:every</code>) are milliseconds, but can also be represented as a keyword or a vector of multiplier/keyword pairs, e.g. <code>[1 :week, 4 :days, 2 :hours, 30 :minutes, 59 :seconds]</code>. Both singular and plural keywords are valid.</p><p>Time values (<code>:at</code> and <code>:until</code>) can be a <code>java.util.Date</code>, a long representing milliseconds-since-epoch, or a String in <code>HH:mm</code> format. The latter will be interpreted as the next occurence of <code>HH:mm:00</code> in the currently active timezone.</p><p>Two additional options may be passed in the spec map:</p>
<ul>
  <li><code>:id</code> - a unique identifier for the scheduled job</li>
  <li><code>:singleton</code> - a boolean denoting the job&rsquo;s behavior in a cluster</li>
</ul><p>In Immutant 1.x, a name for the job was required. In Immutant 2, the <code>:id</code> is optional, and if not provided, a UUID will be generated. If <code>schedule</code> is called with an <code>:id</code> for a job that has already been scheduled, the prior job will be replaced.</p><p>The return value from <code>schedule</code> is a map of the options with any missing defaults filled in, including a generated id if necessary. This result can be passed to <code>stop</code> to cancel the job.</p><h3 id="h5314">Some Examples</h3><p>If you haven&rsquo;t already, you should read through the <a href="guide-installation.html">installation</a> guide and require the <code>immutant.scheduling</code> namespace at a REPL to follow along:</p>
<pre><code class="clojure">(require &#39;[immutant.scheduling :refer :all])
</code></pre><p>We&rsquo;ll need a job to schedule. Here&rsquo;s one!</p>
<pre><code class="clojure">(defn job []
  (prn &#39;fire!))
</code></pre><p>Let&rsquo;s schedule it:</p>
<pre><code class="clojure">(schedule job)
</code></pre><p>That was pretty useless. Without a spec, the job will immediately be called once asynchronously on one of the Quartz scheduler&rsquo;s threads. Instead, let&rsquo;s have it run in 5 minutes:</p>
<pre><code class="clojure">(schedule job (in 5 :minutes))
</code></pre><p>And maybe run again every second after that:</p>
<pre><code class="clojure">(schedule job
  (-&gt; (in 5 :minutes)
    (every :second)))
</code></pre><p>But no more than 60 times:</p>
<pre><code class="clojure">(schedule job
  (-&gt; (in 5 :minutes)
    (every :second)
    (limit 60)))
</code></pre><p>We could also anticipate getting stupid bored about halfway through, and schedule another job to cancel the first one:</p>
<pre><code class="clojure">(let [it (schedule job
           (-&gt; (in 5 :minutes)
             (every :second)
             (limit 60)))]
  (schedule #(stop it) (in 5 :minutes, 30 :seconds)))
</code></pre><p>Of course, you can bring your own job id&rsquo;s if you like:</p>
<pre><code class="clojure">(schedule job (-&gt; (id :purge) (every 30 :minutes)))
(schedule job (-&gt; (id :purge) (every :hour)))  ; reschedule
(stop (id :purge))
</code></pre><p>If a job is successfully canceled, <code>stop</code> returns true.</p><h3 id="h5315">It&rsquo;s Just Maps</h3><p>Ultimately, the spec passed to <code>schedule</code> is just a map, and the sugar functions are just assoc&rsquo;ing keys corresponding to their names. The map can be passed either explicitly or via keyword arguments, so all of the following are equivalent:</p>
<pre><code class="clojure">(schedule job (-&gt; (in 5 :minutes) (every :day)))
(schedule job {:in [5 :minutes], :every :day})
(schedule job :in [5 :minutes], :every :day)
</code></pre><h3 id="h5316">Supports Joda clj-time</h3><p>If you&rsquo;re using the <a href="https://github.com/clj-time/clj-time">clj-time</a> library in your project, you can load the <a href="immutant.scheduling.joda.html">immutant.scheduling.joda</a> namespace. This will extend <code>org.joda.time.DateTime</code> instances to the <a href="immutant.coercions.html#var-AsTime">immutant.coercions/AsTime</a> protocol, enabling them to be used as arguments to <code>at</code> and <code>until</code>, e.g.</p>
<pre><code class="clojure">(require &#39;[clj-time.core :refer [today-at plus hours]])

(let [t (today-at 9 00)]
  (schedule job
    (-&gt; (at t)
      (every 2 :hours)
      (until (plus t (hours 8))))))
</code></pre><p>The <code>immutant.scheduling.joda</code> namespace also provides <a href="immutant.scheduling.joda.html#var-schedule-seq">immutant.scheduling.joda/schedule-seq</a>. Inspired by <a href="https://github.com/james-henderson/chime#chime-at">chime-at</a>, it takes not a specification map but a sequence of times, as might be returned from <code>clj-time.periodic/periodic-seq</code>, subject to the application of any of Clojure&rsquo;s core sequence-manipulating functions.</p><p>When defining complex recurring schedules, this presents an interesting alternative to traditional cron specs. For example, consider a job that must run at 10am every weekday. Here&rsquo;s how we&rsquo;d schedule that with a <a href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/tutorial-lesson-06">Quartz-style</a> cron spec:</p>
<pre><code class="clojure">(schedule job (cron &quot;0 0 10 ? * MON-FRI&quot;))
</code></pre><p>And here&rsquo;s the same schedule using a lazy sequence:</p>
<pre><code class="clojure">(require &#39;[immutant.scheduling.joda :refer [schedule-seq]]
         &#39;[clj-time.core            :refer [today-at days]]
         &#39;[clj-time.periodic        :refer [periodic-seq]]
         &#39;[clj-time.predicates      :refer [weekday?]])

(schedule-seq job
  (-&gt;&gt; (periodic-seq (today-at 10 0) (days 1))
    (filter weekday?)))
</code></pre><p>So each has trade-offs, of course. The cron spec is more concise, but also arguably more error-prone, e.g. what is that <code>?</code> for!?</p><p>One very cool thing about the sequence is that I can test it without actually scheduling it. On the other hand, my cron spec test is going to take more than a week to run! ;)</p><h2 id="h5317">Accessing the internal Quartz scheduler</h2><p>If you need access to the internal Quartz scheduler instance (maybe to pass to another Quartz-based scheduling library like <a href="http://clojurequartz.info/">Quartzite</a>), use <a href="immutant.scheduling.quartz.html#var-quartz-scheduler">immutant.scheduling.quartz/quartz-scheduler</a>. You just need to pass it the same scheduler options you can pass to <a href="immutant.scheduling.html#var-schedule">immutant.scheduling/schedule</a>.</p></div></div></div><script src="assets/jquery.syntax.min.js" type="text/javascript"></script><script src="assets/immutant.js" type="text/javascript"></script></body></html>